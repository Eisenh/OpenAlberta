<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Open Data Graph Search</title>
  <script type="text/javascript">
    // Single Page Apps for GitHub Pages
    // MIT License
    // https://github.com/rafgraph/spa-github-pages
    // This script takes the current URL and redirects to the same path at the
    // main index.html file, allowing client-side routing to handle the path

    // Special handling for Supabase auth tokens (for any auth flow)
    if (window.location.hash && window.location.hash.includes('access_token=')) {
      console.log("Detected access token in URL hash");

      const hash = window.location.hash;
      const projectPath = import.meta.env.VITE_GITHUB_PAGES || '';  // GitHub Pages repository name

      // Parse the hash parameters using proper URL parameter extraction
      // Fix: Use URLSearchParams to correctly extract the 'type' parameter (not token_type)
      const hashParams = new URLSearchParams(hash.substring(1));
      const authType = hashParams.get('type');  // This properly gets the 'type' parameter only

      console.log("404 Auth type:", authType);
      console.log("404 hashparams Auth type:", authType, "hashParams: ", hashParams);

      function getParameterByName(name, url) {
        name = name.replace(/[\[\]]/g, '\\$&');
        // Modify the regex to specifically look for '&' before the name
        const regex = new RegExp('[&?]\\b' + name + '\\b(=([^&#]*)|&|#|$)');
        const results = regex.exec(url);

        if (!results) {
          return null;
        }

        if (!results[2]) {
          return '';
        }

        const parsed = decodeURIComponent(results[2].replace(/\+/g, ' '));
        console.log("404 parsed ", parsed);
        return parsed;
      }

      function getAmpersandTypeParameter(url) {
        return getParameterByName('&type', url);
      }
      
      const fragment = window.location.hash.substring(1);
      const type = getAmpersandTypeParameter('type', fragment);
      console.log("404, type = ", type, " Fragment: ", fragment);


      // Determine the correct route based on the type parameter
      let redirectRoute = '#/';

      if (authType) {
        // Route based on the auth type
        switch (authType) {
          case 'recovery':
            redirectRoute = '#/reset-password';
            break;
          case 'email':
            redirectRoute = '#/verify-email';
            break;
          case 'signup':
            redirectRoute = '#/verify-email';
            break;
          case 'magiclink':
            redirectRoute = '#/login';
            break;
          default:
            redirectRoute = '#/';
        }
      }
      console.log("404 redirect top ", `${projectPath}${redirectRoute}${hash}`);
      // Redirect to the appropriate page with the token
      window.location.replace(`${projectPath}${redirectRoute}${hash}`);
    }
    // Standard SPA GitHub Pages redirect for non-auth URLs
    else {
      (function (l) {
        if (l.search[1] === '/') {
          var decoded = l.search.slice(1).split('&').map(function (s) {
            return s.replace(/~and~/g, '&')
          }).join('?');
          window.history.replaceState(null, null,
            l.pathname.slice(0, -1) + decoded + l.hash
          );
        }
      }(window.location))

      // Get the base path from the <base> tag if it exists, or default to '/'
      var basePath = document.querySelector('base') ? document.querySelector('base').getAttribute('href') : '/';

      // Redirect to the index page with the current path
      var segmentCount = 0;
      var location = window.location;

      // GitHub Pages serves 404.html from the repo root, so we need to redirect
      // to the correct path based on the repository name (which is encoded in the base path)
      var redirectUrl = location.protocol + '//' + location.hostname +
        (location.port ? ':' + location.port : '') +
        basePath.replace(/\/$/, '') +
        '/?p=' + location.pathname.slice(1).replace(/&/g, '~and~') +
        (location.search ? '&q=' + location.search.slice(1).replace(/&/g, '~and~') : '') +
        (location.hash || '');

          console.log("404 normal redirectUrl", redirectUrl);
      // Use replaceState instead of redirect to maintain URL structure
      window.history.replaceState(null, null, redirectUrl);
      window.location.reload();
    }
  </script>
</head>

<body>
  <h1>Redirecting...</h1>
  <p>
    If you are not redirected automatically, follow this
    <a href="#/">link to the homepage</a>.
  </p>
</body>

</html>
